{{- if and .is_control_plane (not .is_bootstrap) }}#!/bin/bash
set -euo pipefail

# Join control plane node {{ .hostname }} to K3s cluster
echo "Joining {{ .hostname }} to K3s cluster as control plane..."

# Verify K3S token file exists
if [[ ! -f "/var/lib/rancher/k3s/server/token" ]]; then
    echo "K3S token file /var/lib/rancher/k3s/server/token does not exist"
    echo "This file must be present before joining control plane"
    exit 1
fi

K3S_TOKEN=$(cat /var/lib/rancher/k3s/server/token)

# Wait for virtual IP to be available (bootstrap node should have it)
echo "⏳ Waiting for virtual IP {{ .network.virtual_ip }} to be available..."
timeout 300 bash -c 'until ping -c 1 {{ .network.virtual_ip }} >/dev/null 2>&1; do
    echo "Waiting for virtual IP..."
    sleep 10
done'

# Wait for K3s API to be available
echo "⏳ Waiting for K3s API at {{ .network.virtual_ip }}:6443..."
timeout 300 bash -c 'until nc -z {{ .network.virtual_ip }} 6443; do
    echo "Waiting for K3s API..."
    sleep 10
done'

# Install K3s server (joining existing cluster)
echo "Installing K3s server and joining cluster..."
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ .k3s.version }}" sh -s - server

# Wait for this node to be ready
echo "Waiting for {{ .hostname }} to be ready..."
timeout 300 bash -c 'until sudo k3s kubectl get node/{{ .hostname }} >/dev/null 2>&1; do sleep 5; done'
sudo k3s kubectl wait --for=condition=Ready node/{{ .hostname }} --timeout=300s

# Copy kubeconfig with proper permissions
echo "Setting up kubeconfig..."
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
chmod 600 ~/.kube/config

# Update kubeconfig to use virtual IP
sed -i 's/127.0.0.1/{{ .network.virtual_ip }}/g' ~/.kube/config

# Display cluster info
echo "{{ .hostname }} joined cluster successfully!"
echo "Cluster nodes:"
kubectl get nodes -o wide
{{- end }}