#!/bin/bash
set -euo pipefail

# Apply netplan configuration for node {{ .hostname }}
echo "Applying network configuration for {{ .hostname }}..."

# Test the netplan configuration first
if sudo netplan try --timeout=30; then
    echo "Netplan configuration applied successfully"
else
    echo "Failed to apply netplan configuration - rolling back"
    exit 1
fi

# Verify the network configuration is active
echo "Verifying network configuration..."
ip addr show eth0 | grep -F "{{ .node_ip }}"

echo "Network configuration applied and verified for {{ .hostname }}"