{{- if (eq .node_type "server") }}
global_defs {
    router_id {{ .hostname }}
    enable_script_security
    script_user root
}

vrrp_script chk_haproxy {
    script "/usr/bin/timeout 3 /bin/curl -f http://localhost:8404/stats"
    interval 5
    timeout 4
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state {{ .keepalived_state | default "BACKUP" }}
    interface {{ .ha.interface }}
    virtual_router_id {{ .ha.router_id }}
    priority {{ .priority }}
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass {{ env "KEEPALIVED_AUTH_PASS" | default "k3s-cluster-auth" }}
    }

    virtual_ipaddress {
        {{ .ha.virtual_ip }}/24 dev {{ .ha.interface }}
    }

    track_script {
        chk_haproxy
    }

    notify_master "/etc/keepalived/scripts/master.sh"
    notify_backup "/etc/keepalived/scripts/backup.sh"
    notify_fault "/etc/keepalived/scripts/fault.sh"
}
{{- end }}