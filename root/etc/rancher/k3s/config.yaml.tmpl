{{- if eq .node_type "server" }}
# K3s server configuration for control plane nodes
token-file: /var/lib/rancher/k3s/server/token
{{- if .bootstrap }}
cluster-init: true
write-kubeconfig-mode: "0644"
{{- else }}
server: https://{{ .network.virtual_ip }}:6443
{{- end }}

# Network configuration
cluster-cidr: {{ .k3s.cluster_cidr }}
service-cidr: {{ .k3s.service_cidr }}
cluster-dns: {{ .k3s.cluster_dns }}

# Node configuration
node-ip: {{ .ip }}
node-external-ip: {{ .ip }}
advertise-address: {{ .ip }}
bind-address: {{ .ip }}

# TLS configuration
tls-san:
  - {{ .network.virtual_ip }}
  - k3s-api
  - k3s-cluster
  - {{ .ip }}
  - {{ .hostname }}

# Disable components (we'll use external/Cilium)
disable:
  - traefik
  - servicelb
  - flannel

# Datastore configuration (using embedded etcd with cluster-init)

# Kubelet configuration
kubelet-arg:
  - "node-ip={{ .ip }}"
  - "cluster-dns={{ .k3s.cluster_dns }}"

# API server configuration
kube-apiserver-arg:
  - "advertise-address={{ .ip }}"
  - "bind-address=0.0.0.0"

# Controller manager configuration
kube-controller-manager-arg:
  - "bind-address=0.0.0.0"

# Scheduler configuration
kube-scheduler-arg:
  - "bind-address=0.0.0.0"

# CNI configuration (Cilium will be installed via CLI)
flannel-backend: none
disable-network-policy: true
{{- else }}
# K3s agent configuration for worker nodes
token-file: /var/lib/rancher/k3s/server/token
server: https://{{ .network.virtual_ip }}:6443

# Node configuration
node-ip: {{ .ip }}
node-external-ip: {{ .ip }}

# Kubelet configuration
kubelet-arg:
  - "node-ip={{ .ip }}"
  - "cluster-dns={{ .k3s.cluster_dns }}"
  - "max-pods=250"

# Node labels
node-label:
  - "node.kubernetes.io/instance-type=raspberry-pi-5"
  - "storage.kubernetes.io/nvme=true"

# Node taints (if needed for specialized workloads)
# node-taint:
#   - "workload=storage:NoSchedule"
{{- end }}