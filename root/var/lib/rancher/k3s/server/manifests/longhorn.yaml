---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: longhorn
  namespace: kube-system
spec:
  repo: https://charts.longhorn.io
  chart: longhorn
  targetNamespace: longhorn-system
  createNamespace: true
  valuesContent: |-
    defaultSettings:
      # Enable v2 data engine
      v2DataEngine: true
      v2DataEngineHugepageLimit: "2048"

      # Replica settings
      defaultReplicaCount: "2"
      replicaAutoBalance: best-effort

      # Storage configuration
      storageOverProvisioningPercentage: "200"
      storageMinimalAvailablePercentage: "10"

      # Network settings
      guaranteedInstanceManagerCPU: "12"

      # Enable node label-based disk configuration
      # This allows per-node control of allowScheduling via node annotations
      createDefaultDiskLabeledNodes: true

      # Storage components only run on workers with NVMe
      systemManagedComponentsNodeSelector: "l8s.linnaeus.dev/storage:nvme"

    # Manager must run on ALL nodes to discover and manage them
    longhornManager:
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule

    # Driver deployer on control plane
    longhornDriver:
      nodeSelector:
        node-role.kubernetes.io/control-plane: "true"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule

    # UI on control plane for easier access
    longhornUI:
      nodeSelector:
        node-role.kubernetes.io/control-plane: "true"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
