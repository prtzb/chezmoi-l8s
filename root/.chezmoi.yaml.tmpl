{{- $hostname := .chezmoi.hostname -}}
{{- $nodes := (include "./root/nodes.yaml" | fromYaml).nodes -}}

data:
  # Node identification
  hostname: {{ $hostname | quote }}
  ip: {{ (index $nodes $hostname).ip | quote }}
  node_type: {{ ((index $nodes $hostname).node_type | default "unknown") }}
  bootstrap: {{ (index $nodes $hostname).bootstrap | default false }}
  {{ if (eq (index $nodes $hostname).node_type "server" ) -}}
  router_id: {{ (index $nodes $hostname).router_id | default 0 }}
  priority: {{ (index $nodes $hostname).priority | default 0 }}
  keepalived_state: {{ (index $nodes $hostname).keepalived_state | default "UNKNOWN" }}
  {{ end -}}
  nodes: {{ $nodes | toYaml }}

  # Network configuration
  network:
    gateway: "10.0.1.1"
    dns: "10.0.1.1"
    subnet_mask: "255.255.255.0"
    virtual_ip: "10.0.1.128"

  # K3s configuration
  k3s:
    version: "v1.33.4+k3s1"
    cluster_cidr: "10.42.0.0/16"
    service_cidr: "10.43.0.0/16"
    cluster_dns: "10.43.0.10"

  # Cluster configuration
  cluster_name: "chezmoi-l8s"

  # HA configuration for servers
  ha:
    enabled: {{ eq ((index $nodes $hostname).node_type | default "unknown") "server" }}
    virtual_ip: "10.0.1.128"
    interface: "eth0"
    router_id: {{ if eq ((index $nodes $hostname).node_type | default "unknown") "server" }}{{ (index $nodes $hostname).router_id }}{{ else }}0{{ end }}

destDir: "/"
